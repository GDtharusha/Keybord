<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>KeyBord Settings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, #0f0f1a, #1a1a2e);
            color: #fff;
            min-height: 100vh;
            padding: 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            padding-bottom: max(100px, env(safe-area-inset-bottom));
            user-select: none;
        }
        
        .header {
            text-align: center;
            padding: 24px 0;
        }
        
        .header .logo {
            font-size: 56px;
            margin-bottom: 12px;
        }
        
        .header h1 {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        
        .header p {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }
        
        .connection-banner {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .connection-banner.connected {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        .connection-banner .banner-text {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connection-banner .banner-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            cursor: pointer;
        }
        
        .connection-banner .banner-btn:active {
            transform: scale(0.95);
        }
        
        .status-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .status-item {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.15s;
        }
        
        .status-item:active {
            transform: scale(0.97);
        }
        
        .status-item .icon {
            font-size: 24px;
            margin-bottom: 6px;
        }
        
        .status-item .label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .status-item .value {
            font-size: 13px;
            font-weight: 600;
            margin-top: 4px;
        }
        
        .value.success {
            color: #10b981;
        }
        
        .value.warning {
            color: #f59e0b;
        }
        
        .value.error {
            color: #ef4444;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .card h2 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 14px;
            color: #3b82f6;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: transform 0.1s, opacity 0.1s;
        }
        
        .btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .btn:last-child {
            margin-bottom: 0;
        }
        
        .btn-primary {
            background: linear-gradient(180deg, #3b82f6, #2563eb);
            color: #fff;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .btn-accent {
            background: linear-gradient(180deg, #8b5cf6, #7c3aed);
            color: #fff;
        }
        
        .btn-success {
            background: linear-gradient(180deg, #10b981, #059669);
            color: #fff;
        }
        
        .btn-danger {
            background: linear-gradient(180deg, #ef4444, #dc2626);
            color: #fff;
        }
        
        .section-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 12px;
            display: block;
        }
        /* Theme Options - 3 buttons */
        
        .theme-options {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .theme-option {
            flex: 1;
            padding: 16px 12px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .theme-option:active {
            transform: scale(0.95);
        }
        
        .theme-option.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }
        
        .theme-option .theme-preview {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            margin: 0 auto 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .theme-option .theme-name {
            font-size: 12px;
            font-weight: 600;
        }
        
        .theme-black {
            background: #1a1a2e;
        }
        
        .theme-black .theme-preview {
            background: linear-gradient(135deg, #000000, #1a1a1a);
        }
        
        .theme-white {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .theme-white .theme-preview {
            background: linear-gradient(135deg, #ffffff, #e0e0e0);
        }
        
        .theme-white .theme-name {
            color: #fff;
        }
        
        .theme-custom {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .theme-custom .theme-preview {
            background: linear-gradient(135deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
            border: none;
        }
        /* Color Picker */
        
        .color-picker-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .color-option {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .color-option:active {
            transform: scale(0.9);
        }
        
        .color-option.selected {
            border-color: #3b82f6;
            transform: scale(1.1);
        }
        
        .color-option-black {
            background: #000000;
            border: 2px solid #333;
        }
        
        .color-option-white {
            background: #ffffff;
        }
        
        .color-option-custom {
            background: linear-gradient(135deg, #ff6b6b, #feca57, #48dbfb);
            position: relative;
            overflow: hidden;
        }
        
        .custom-color-input {
            flex: 1;
            height: 44px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            padding: 0 12px;
            color: #fff;
            font-size: 14px;
        }
        
        .custom-color-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .color-preview-box {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .setting-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .setting-info .label {
            font-size: 15px;
            font-weight: 500;
        }
        
        .setting-info .sublabel {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 2px;
        }
        
        .toggle {
            width: 52px;
            height: 30px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        
        .toggle.active {
            background: #3b82f6;
        }
        
        .toggle::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle.active::after {
            transform: translateX(22px);
        }
        
        .slider-container {
            padding: 14px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .slider-container:last-child {
            border-bottom: none;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .slider-label {
            font-size: 15px;
            font-weight: 500;
        }
        
        .slider-value {
            font-size: 14px;
            color: #3b82f6;
            font-weight: 600;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .test-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }
        
        .test-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .test-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .test-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
        }
        
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 14px 24px;
            border-radius: 30px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
            max-width: 90%;
            text-align: center;
            pointer-events: none;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="logo">‚å®Ô∏è</div>
        <h1>KeyBord</h1>
        <p>High-Performance Custom Keyboard</p>
    </div>

    <div class="connection-banner" id="connectionBanner">
        <span class="banner-text" id="bannerText">
            <span id="bannerIcon">‚è≥</span>
        <span id="bannerMessage">Connecting...</span>
        </span>
        <button class="banner-btn" id="bannerBtn" onclick="forceReload()">Reload</button>
    </div>

    <div class="status-bar">
        <div class="status-item" onclick="openKeyboardSettings()">
            <div class="icon">‚öôÔ∏è</div>
            <div class="label">Keyboard</div>
            <div class="value" id="statusEnabled">Checking...</div>
        </div>
        <div class="status-item" onclick="showKeyboardPicker()">
            <div class="icon">‚úì</div>
            <div class="label">Status</div>
            <div class="value" id="statusActive">Checking...</div>
        </div>
        <div class="status-item" onclick="requestOverlayPermission()">
            <div class="icon">üî≤</div>
            <div class="label">Overlay</div>
            <div class="value" id="statusOverlay">Checking...</div>
        </div>
    </div>

    <div class="card">
        <h2>üöÄ Quick Setup</h2>
        <button class="btn btn-primary" onclick="openKeyboardSettings()">
            ‚öôÔ∏è Step 1: Enable KeyBord
        </button>
        <button class="btn btn-success" onclick="showKeyboardPicker()">
            ‚úì Step 2: Switch to KeyBord
        </button>
    </div>

    <!-- Theme Card -->
    <div class="card">
        <h2>üé® Keyboard Theme</h2>
        <span class="section-label">Background Color</span>
        <div class="theme-options">
            <div class="theme-option theme-black selected" data-theme="black" onclick="selectTheme('black')">
                <div class="theme-preview"></div>
                <div class="theme-name">Black</div>
            </div>
            <div class="theme-option theme-white" data-theme="white" onclick="selectTheme('white')">
                <div class="theme-preview"></div>
                <div class="theme-name">White</div>
            </div>
            <div class="theme-option theme-custom" data-theme="custom" onclick="selectTheme('custom')">
                <div class="theme-preview"></div>
                <div class="theme-name">Custom</div>
            </div>
        </div>

        <!-- Custom Background Color -->
        <div id="customBgSection" style="display:none;">
            <span class="section-label">Custom Background Color</span>
            <div class="color-picker-row">
                <input type="text" class="custom-color-input" id="customBgColor" placeholder="#1a1a2e" value="#1a1a2e" oninput="updateCustomBgColor(this.value)">
                <div class="color-preview-box" id="bgColorPreview" style="background:#1a1a2e;"></div>
            </div>
        </div>

        <!-- Text Color -->
        <span class="section-label">Text Color</span>
        <div class="color-picker-row">
            <div class="color-option color-option-white selected" data-textcolor="white" onclick="selectTextColor('white')">A</div>
            <div class="color-option color-option-black" data-textcolor="black" onclick="selectTextColor('black')" style="color:#fff;">A</div>
            <div class="color-option color-option-custom" data-textcolor="custom" onclick="selectTextColor('custom')">üé®</div>
            <input type="text" class="custom-color-input" id="customTextColor" placeholder="#ffffff" value="#ffffff" oninput="updateCustomTextColor(this.value)" style="display:none;">
        </div>
    </div>

    <!-- Settings Card -->
    <div class="card">
        <h2>‚öôÔ∏è Preferences</h2>

        <div class="setting-row">
            <div class="setting-info">
                <div class="label">Vibration</div>
                <div class="sublabel">Haptic feedback on key press</div>
            </div>
            <div class="toggle active" id="toggle_vibration" onclick="toggleSetting('vibration')"></div>
        </div>

        <div class="slider-container" id="vibrationSlider">
            <div class="slider-header">
                <span class="slider-label">Vibration Strength</span>
                <span class="slider-value" id="vibrationValue">5ms</span>
            </div>
            <input type="range" class="slider" id="vibrationStrengthSlider" min="1" max="30" value="5" oninput="updateVibrationStrength(this.value)">
        </div>

        <div class="setting-row">
            <div class="setting-info">
                <div class="label">Quick Emoji Row</div>
                <div class="sublabel">Show emoji row above keyboard</div>
            </div>
            <div class="toggle" id="toggle_emoji_row" onclick="toggleSetting('emoji_row')"></div>
        </div>

        <div class="slider-container">
            <div class="slider-header">
                <span class="slider-label">Keyboard Height</span>
                <span class="slider-value" id="heightValue">245dp</span>
            </div>
            <input type="range" class="slider" id="heightSlider" min="200" max="300" value="245" oninput="updateKeyboardHeight(this.value)">
        </div>

        <div class="slider-container">
            <div class="slider-header">
                <span class="slider-label">Key Size</span>
                <span class="slider-value" id="keySizeValue">20sp</span>
            </div>
            <input type="range" class="slider" id="keySizeSlider" min="16" max="28" value="20" oninput="updateKeySize(this.value)">
        </div>

        <div class="slider-container">
            <div class="slider-header">
                <span class="slider-label">Key Gap</span>
                <span class="slider-value" id="keyGapValue">2dp</span>
            </div>
            <input type="range" class="slider" id="keyGapSlider" min="0" max="10" value="2" oninput="updateKeyGap(this.value)">
        </div>

        <div class="slider-container" style="border-bottom:none;">
            <div class="slider-header">
                <span class="slider-label">Key Roundness</span>
                <span class="slider-value" id="radiusValue">8dp</span>
            </div>
            <input type="range" class="slider" id="radiusSlider" min="0" max="20" value="8" oninput="updateKeyRadius(this.value)">
        </div>
    </div>

    <!-- Tools Card -->
    <div class="card">
        <h2>üõ†Ô∏è Tools</h2>
        <button class="btn btn-accent" onclick="showFloatingWindow()">
            ‚ú® Open Settings Popup
        </button>
        <button class="btn btn-secondary" onclick="requestOverlayPermission()">
            üîì Grant Overlay Permission
        </button>
        <button class="btn btn-danger" onclick="resetAllSettings()">
            ‚ö†Ô∏è Reset All Settings
        </button>
    </div>

    <!-- Test Card -->
    <div class="card">
        <h2>üß™ Test Keyboard</h2>
        <div class="test-section">
            <label class="section-label">Tap below to test (try emojis too üòÄüî•‚ù§Ô∏è):</label>
            <input type="text" class="test-input" placeholder="Type something here...">
            <input type="text" class="test-input" placeholder="Try deleting emojis..." style="margin-top:8px;">
        </div>
    </div>

    <div class="footer">
        KeyBord v1.0.0<br> Made with ‚ù§Ô∏è<br>
        <span id="bridgeStatus" style="font-size:10px; color:rgba(255,255,255,0.2);">Initializing...</span>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        var bridgeReady = false;
        var connectionCheckInterval = null;
        var checkCount = 0;

        // Current settings state
        var currentTheme = 'black';
        var currentTextColor = 'white';
        var customBgColor = '#1a1a2e';
        var customTextColorValue = '#ffffff';

        function getNativeBridge() {
            if (typeof NativeSettings !== 'undefined' && NativeSettings !== null) {
                return NativeSettings;
            }
            return null;
        }

        function isBridgeAvailable() {
            var bridge = getNativeBridge();
            if (bridge) {
                try {
                    bridge.log('Bridge check');
                    return true;
                } catch (e) {
                    return false;
                }
            }
            return false;
        }

        function updateConnectionUI(connected) {
            var banner = document.getElementById('connectionBanner');
            var icon = document.getElementById('bannerIcon');
            var message = document.getElementById('bannerMessage');
            var btn = document.getElementById('bannerBtn');
            var status = document.getElementById('bridgeStatus');

            if (connected) {
                banner.classList.add('connected');
                icon.textContent = '‚úì';
                message.textContent = 'Connected to keyboard service';
                btn.textContent = 'Refresh';
                btn.onclick = forceReload;
                status.textContent = 'Native Bridge: Connected ‚úì';
                bridgeReady = true;
            } else {
                banner.classList.remove('connected');
                icon.textContent = '‚è≥';
                message.textContent = 'Connecting... (' + checkCount + ')';
                btn.textContent = 'Reload';
                btn.onclick = forceReload;
                status.textContent = 'Native Bridge: Connecting...';
                bridgeReady = false;
            }
        }

        function startConnectionCheck() {
            checkCount = 0;
            connectionCheckInterval = setInterval(function() {
                checkCount++;
                if (isBridgeAvailable()) {
                    clearInterval(connectionCheckInterval);
                    connectionCheckInterval = null;
                    updateConnectionUI(true);
                    loadAllSettings();
                    checkAllStatus();
                    showToast('‚úì Connected!');
                } else if (checkCount >= 50) {
                    clearInterval(connectionCheckInterval);
                    connectionCheckInterval = null;
                    updateConnectionUI(false);
                    document.getElementById('bannerMessage').textContent = 'Connection failed - tap Reload';
                    loadFromLocalStorage();
                } else {
                    updateConnectionUI(false);
                }
            }, 100);
        }

        function forceReload() {
            location.reload();
        }

        function checkAllStatus() {
            if (!bridgeReady) return;
            try {
                var bridge = getNativeBridge();
                if (!bridge) return;

                var isEnabled = bridge.isKeyboardEnabled();
                var enabledEl = document.getElementById('statusEnabled');
                enabledEl.textContent = isEnabled ? 'Enabled ‚úì' : 'Disabled';
                enabledEl.className = 'value ' + (isEnabled ? 'success' : 'error');

                var isActive = bridge.isKeyboardActive();
                var activeEl = document.getElementById('statusActive');
                activeEl.textContent = isActive ? 'Active ‚úì' : 'Not Active';
                activeEl.className = 'value ' + (isActive ? 'success' : 'warning');

                var canOverlay = bridge.canDrawOverlays();
                var overlayEl = document.getElementById('statusOverlay');
                overlayEl.textContent = canOverlay ? 'Granted ‚úì' : 'Denied';
                overlayEl.className = 'value ' + (canOverlay ? 'success' : 'warning');
            } catch (e) {
                console.error('Status check error:', e);
            }
        }

        function openKeyboardSettings() {
            if (bridgeReady) {
                try {
                    getNativeBridge().openKeyboardSettings();
                    showToast('üì± Opening settings...');
                } catch (e) {}
            } else {
                showToast('üì± Go to: Settings ‚Üí System ‚Üí Keyboard');
            }
        }

        function showKeyboardPicker() {
            if (bridgeReady) {
                try {
                    getNativeBridge().showKeyboardPicker();
                    showToast('‚å®Ô∏è Select KeyBord');
                } catch (e) {}
            }
        }

        function requestOverlayPermission() {
            if (bridgeReady) {
                try {
                    getNativeBridge().requestOverlayPermission();
                    showToast('üîì Opening permissions...');
                } catch (e) {}
            }
        }

        function showFloatingWindow() {
            if (bridgeReady) {
                try {
                    getNativeBridge().showFloatingWindow();
                } catch (e) {}
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // THEME FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function selectTheme(theme) {
            currentTheme = theme;

            document.querySelectorAll('.theme-option').forEach(function(el) {
                el.classList.remove('selected');
                if (el.dataset.theme === theme) {
                    el.classList.add('selected');
                }
            });

            document.getElementById('customBgSection').style.display = (theme === 'custom') ? 'block' : 'none';

            var bgColor = '#1a1a2e';
            if (theme === 'black') {
                bgColor = '#000000';
            } else if (theme === 'white') {
                bgColor = '#f5f5f5';
            } else if (theme === 'custom') {
                bgColor = customBgColor;
            }

            localStorage.setItem('theme', theme);
            localStorage.setItem('bg_color', bgColor);

            if (bridgeReady) {
                try {
                    getNativeBridge().setBackgroundColor(bgColor);
                    // Auto-adjust text color for white theme
                    if (theme === 'white' && currentTextColor === 'white') {
                        selectTextColor('black');
                    }
                } catch (e) {}
            }

            showToast('üé® Theme: ' + theme);
        }

        function updateCustomBgColor(color) {
            if (color.match(/^#[0-9A-Fa-f]{6}$/)) {
                customBgColor = color;
                document.getElementById('bgColorPreview').style.background = color;
                localStorage.setItem('custom_bg_color', color);
                localStorage.setItem('bg_color', color);

                if (bridgeReady && currentTheme === 'custom') {
                    try {
                        getNativeBridge().setBackgroundColor(color);
                    } catch (e) {}
                }
            }
        }

        function selectTextColor(colorType) {
            currentTextColor = colorType;

            document.querySelectorAll('.color-option').forEach(function(el) {
                el.classList.remove('selected');
                if (el.dataset.textcolor === colorType) {
                    el.classList.add('selected');
                }
            });

            document.getElementById('customTextColor').style.display = (colorType === 'custom') ? 'block' : 'none';

            var textColor = '#ffffff';
            if (colorType === 'white') {
                textColor = '#ffffff';
            } else if (colorType === 'black') {
                textColor = '#000000';
            } else if (colorType === 'custom') {
                textColor = customTextColorValue;
            }

            localStorage.setItem('text_color_type', colorType);
            localStorage.setItem('text_color', textColor);

            if (bridgeReady) {
                try {
                    getNativeBridge().setTextColor(textColor);
                } catch (e) {}
            }

            showToast('üé® Text color updated');
        }

        function updateCustomTextColor(color) {
            if (color.match(/^#[0-9A-Fa-f]{6}$/)) {
                customTextColorValue = color;
                localStorage.setItem('custom_text_color', color);
                localStorage.setItem('text_color', color);

                if (bridgeReady && currentTextColor === 'custom') {
                    try {
                        getNativeBridge().setTextColor(color);
                    } catch (e) {}
                }
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SETTINGS FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function toggleSetting(settingName) {
            var toggle = document.getElementById('toggle_' + settingName);
            toggle.classList.toggle('active');
            var isActive = toggle.classList.contains('active');

            if (settingName === 'vibration') {
                document.getElementById('vibrationSlider').style.display = isActive ? 'block' : 'none';
            }

            localStorage.setItem(settingName, isActive ? 'true' : 'false');

            if (bridgeReady) {
                try {
                    getNativeBridge().saveSettingBool(settingName, isActive);
                } catch (e) {}
            }

            showToast(settingName + ': ' + (isActive ? 'ON' : 'OFF'));
        }

        function updateVibrationStrength(value) {
            document.getElementById('vibrationValue').textContent = value + 'ms';
            localStorage.setItem('vibration_strength', value);
            if (bridgeReady) {
                try {
                    getNativeBridge().saveSettingInt('vibration_strength', parseInt(value));
                } catch (e) {}
            }
        }

        function updateKeyboardHeight(value) {
            document.getElementById('heightValue').textContent = value + 'dp';
            localStorage.setItem('keyboard_height', value);
            if (bridgeReady) {
                try {
                    getNativeBridge().saveSettingInt('keyboard_height', parseInt(value));
                } catch (e) {}
            }
        }

        function updateKeySize(value) {
            document.getElementById('keySizeValue').textContent = value + 'sp';
            localStorage.setItem('key_text_size', value);
            if (bridgeReady) {
                try {
                    getNativeBridge().saveSettingInt('key_text_size', parseInt(value));
                } catch (e) {}
            }
        }

        function updateKeyGap(value) {
            document.getElementById('keyGapValue').textContent = value + 'dp';
            localStorage.setItem('key_gap', value);
            if (bridgeReady) {
                try {
                    getNativeBridge().saveSettingInt('key_gap', parseInt(value));
                } catch (e) {}
            }
        }

        function updateKeyRadius(value) {
            document.getElementById('radiusValue').textContent = value + 'dp';
            localStorage.setItem('key_radius', value);
            if (bridgeReady) {
                try {
                    getNativeBridge().saveSettingInt('key_radius', parseInt(value));
                } catch (e) {}
            }
        }

        function resetAllSettings() {
            if (confirm('Reset all settings to defaults?')) {
                localStorage.clear();
                if (bridgeReady) {
                    try {
                        getNativeBridge().resetAllSettings();
                    } catch (e) {}
                }
                showToast('üîÑ Settings reset!');
                setTimeout(forceReload, 500);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LOAD SETTINGS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function loadAllSettings() {
            if (!bridgeReady) {
                loadFromLocalStorage();
                return;
            }

            try {
                var bridge = getNativeBridge();

                // Load toggles
                var vibEnabled = bridge.getSettingBool('vibration', true);
                document.getElementById('toggle_vibration').classList.toggle('active', vibEnabled);
                document.getElementById('vibrationSlider').style.display = vibEnabled ? 'block' : 'none';

                document.getElementById('toggle_emoji_row').classList.toggle('active', bridge.getSettingBool('emoji_row', false));

                // Load sliders
                var vibStrength = bridge.getSettingInt('vibration_strength', 5);
                document.getElementById('vibrationStrengthSlider').value = vibStrength;
                document.getElementById('vibrationValue').textContent = vibStrength + 'ms';

                var kbHeight = bridge.getSettingInt('keyboard_height', 245);
                document.getElementById('heightSlider').value = kbHeight;
                document.getElementById('heightValue').textContent = kbHeight + 'dp';

                var keySize = bridge.getSettingInt('key_text_size', 20);
                document.getElementById('keySizeSlider').value = keySize;
                document.getElementById('keySizeValue').textContent = keySize + 'sp';

                var keyGap = bridge.getSettingInt('key_gap', 2);
                document.getElementById('keyGapSlider').value = keyGap;
                document.getElementById('keyGapValue').textContent = keyGap + 'dp';

                var keyRadius = bridge.getSettingInt('key_radius', 8);
                document.getElementById('radiusSlider').value = keyRadius;
                document.getElementById('radiusValue').textContent = keyRadius + 'dp';

                // Load theme
                var theme = bridge.getSetting('theme', 'black');
                selectThemeUI(theme);

            } catch (e) {
                console.error('Error loading settings:', e);
                loadFromLocalStorage();
            }
        }

        function selectThemeUI(theme) {
            currentTheme = theme;
            document.querySelectorAll('.theme-option').forEach(function(el) {
                el.classList.toggle('selected', el.dataset.theme === theme);
            });
            document.getElementById('customBgSection').style.display = (theme === 'custom') ? 'block' : 'none';
        }

        function loadFromLocalStorage() {
            var vibEnabled = localStorage.getItem('vibration') !== 'false';
            document.getElementById('toggle_vibration').classList.toggle('active', vibEnabled);
            document.getElementById('vibrationSlider').style.display = vibEnabled ? 'block' : 'none';

            document.getElementById('toggle_emoji_row').classList.toggle('active', localStorage.getItem('emoji_row') === 'true');

            var kbHeight = localStorage.getItem('keyboard_height') || '245';
            document.getElementById('heightSlider').value = kbHeight;
            document.getElementById('heightValue').textContent = kbHeight + 'dp';

            var keySize = localStorage.getItem('key_text_size') || '20';
            document.getElementById('keySizeSlider').value = keySize;
            document.getElementById('keySizeValue').textContent = keySize + 'sp';

            var keyGap = localStorage.getItem('key_gap') || '2';
            document.getElementById('keyGapSlider').value = keyGap;
            document.getElementById('keyGapValue').textContent = keyGap + 'dp';

            var keyRadius = localStorage.getItem('key_radius') || '8';
            document.getElementById('radiusSlider').value = keyRadius;
            document.getElementById('radiusValue').textContent = keyRadius + 'dp';

            var savedTheme = localStorage.getItem('theme') || 'black';
            selectThemeUI(savedTheme);
        }

        function showToast(message) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(function() {
                toast.classList.remove('show');
            }, 2500);
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('KeyBord App Starting...');
            startConnectionCheck();
        });

        window.addEventListener('focus', function() {
            if (bridgeReady) checkAllStatus();
        });

        setInterval(function() {
            if (bridgeReady) checkAllStatus();
        }, 5000);
    </script>
</body>

</html>